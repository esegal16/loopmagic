# Excel Generator Module

Professional Excel workbook generator for LoopMagic deal underwriting.

## Overview

Generates a 2-tab Excel workbook (`.xlsx` format) with:
- **Tab 1 "Proforma"**: Full 5-year financial model with Excel formulas
- **Tab 2 "Analysis"**: Claude's AI-powered commentary and recommendations

## Usage

```typescript
import { generateExcel } from './lib/excel/generator';

const result = await generateExcel({
  property: propertyData,      // PropertyData from scraper
  analysis: analysisResult,    // AnalysisResult from Claude
  includePhotos: false,        // Optional (Phase 0: no photos)
  includeCharts: false,        // Optional (Phase 0: no charts)
});

if (result.success && result.buffer) {
  // Save or send the Excel file
  fs.writeFileSync(result.filename, result.buffer);
}
```

## Proforma Tab Structure

### Color-Coded Cells
- **Light Blue (#E6F2FF)**: Auto-filled from scraped LoopNet data
- **Light Yellow (#FFFACD)**: User input required (financing, assumptions)
- **White**: Calculated values (Excel formulas)

### Sections

1. **Deal Overview**
   - Address, city, property type, units, SF (auto-filled)
   - Acquisition cost (auto-filled from price + closing costs)
   - Going-in cap rate, price/unit, price/SF

2. **Financing**
   - LTV, loan amount, interest rate (user input)
   - Amortization period, IO period
   - Debt service calculations (formulas)
   - Equity required (formula)

3. **Exit**
   - Exit cap rate (user input)
   - Sale costs (user input)
   - Hold period (default: 5 years)

4. **Revenue Drivers**
   - Occupancy (Year 1 vs. stabilized)
   - Monthly rent/unit (default from scraped data if available)
   - Rent growth rate
   - Other revenue (parking, laundry, etc.)

5. **Expense Drivers**
   - OpEx/unit/year (industry default: $7,500)
   - OpEx growth rate
   - Management fee (% of EGI)
   - CapEx reserves

6. **5-Year Projections (Years 1-5)**
   - Revenue: GPR, vacancy, net rent, other revenue, EGI
   - Operating Expenses: OpEx, management fee, total OpEx
   - NOI: Net Operating Income, NOI margin, yield-on-cost
   - CapEx Reserves
   - Debt Service: Interest, principal, DSCR
   - Cash Flow: Unlevered & levered cash flows

7. **Returns Summary**
   - IRR (unlevered & levered) - uses Excel `IRR()` function
   - Equity Multiple
   - Total Profit

### Excel Formulas

All projections use native Excel formulas:
- Revenue growth: `POWER(1+growth_rate, year)`
- Debt service: `PMT(rate/12, nper*12, -loan_amount)*12`
- IRR: `IRR(cash_flow_range)`
- Equity Multiple: `SUM(cash_inflows)/ABS(equity_required)`

## Analysis Tab Structure

### Sections

1. **Header**
   - Title: "AI-POWERED DEAL ANALYSIS"
   - Property address
   - Analysis date
   - Model used (e.g., claude-sonnet-4-5-20250929)

2. **Executive Summary**
   - Recommendation badge (color-coded):
     - Strong Buy: Green (#00B050)
     - Buy: Light Green (#92D050)
     - Hold: Yellow (#FFC000)
     - Pass: Orange (#FF8C00)
     - Avoid: Red (#C00000)
   - Confidence level (High/Medium/Low)
   - Summary paragraph

3. **Financial Metrics**
   - Estimated ROI
   - Cash-on-Cash return
   - DSCR
   - Cap rate analysis
   - Comparable market analysis

4. **Market Insights**
   - Location quality
   - Market trends
   - Competitive position
   - Growth potential

5. **Risk Assessment**
   - Risk summary
   - Major concerns (bulleted list)
   - Mitigation strategies (bulleted list)

6. **Value-Add Opportunities**
   - Bulleted list of potential improvements/strategies

7. **Key Takeaways**
   - Bulleted list of critical points

8. **Detailed Analysis**
   - Full narrative (2-3 paragraphs)

9. **Footer**
   - "Generated by LoopMagic - AI-Powered Deal Underwriting"
   - Disclaimer

## File Naming Convention

Format: `{address}-analysis-{timestamp}.xlsx`

Example: `2162-SW-14th-Ter-Miami-FL-33145-analysis-2026-02-06.xlsx`

- Address: Slugified (special chars removed, spaces replaced with hyphens)
- Timestamp: `YYYY-MM-DD` format

## Error Handling

### Graceful Degradation
- **Missing units**: Shows 0, user must fill manually
- **Missing cap rate**: Shows blank cell
- **Missing analysis metrics**: Skips that row in Analysis tab
- **Empty arrays**: Skips those sections

### Error Response
Returns `ExcelGenerationResult`:
```typescript
{
  success: false,
  filename: '',
  error: 'Error message here'
}
```

## Testing

### Unit Tests
Run integration test with real scraped data:
```bash
npx tsx test-excel-generator.ts
```

### Edge Case Tests
Test with missing data:
```bash
npx tsx test-excel-edge-cases.ts
```

### Manual Verification Checklist
- [ ] Open in Excel/Numbers without errors
- [ ] Proforma tab has correct structure
- [ ] Blue cells show scraped data
- [ ] Yellow cells show default values
- [ ] Excel formulas calculate correctly (spot-check IRR, NOI, cash flows)
- [ ] Analysis tab has all sections
- [ ] Recommendation badge is color-coded correctly
- [ ] Formatting is professional and readable

## Dependencies

- `exceljs@^4.4.0` - Excel file generation library

## Future Enhancements (Post-Phase 0)

Not implemented yet:
- [ ] Property photos embedded in Excel
- [ ] Charts and graphs (revenue trend, cash flow waterfall)
- [ ] Sensitivity analysis tables
- [ ] Scenario comparison (Base/Aggressive/Conservative)
- [ ] Automatic benchmarking against market comps

## Architecture Notes

### Why ExcelJS?
- Industry standard (100k+ weekly downloads)
- Full TypeScript support
- Native formula support (no post-processing needed)
- Precise cell styling and formatting control
- Battle-tested with large workbooks

### Performance
- Average generation time: ~100-200ms
- File size: ~14-15 KB (without images)
- Memory usage: <5 MB per workbook

### Maintainability
- Clear separation: Proforma builder vs. Analysis builder
- Helper functions for formatting/styling
- All cell references use Excel formula syntax (easy to debug)
- Color constants defined in helper functions
